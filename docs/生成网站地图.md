# 网站地图生成指南

本项目通过 Astro 的 API 路由动态生成网站地图，基于内容集合自动输出 `sitemap.xml` 与 `sitemap-index.xml`。

## 功能简介

- 自动覆盖首页、博客、页面、笔记四类内容
- 过滤草稿与索引页（文件名以 `-index.md` 结尾）
- 自动设置 `priority` 与 `changefreq`
- 生成完整站点链接，域名来源于 `src/lib/config.ts`
- 响应头包含缓存（`Cache-Control: public, max-age=3600`）并提供错误 fallback
- 输出地址：`/sitemap.xml` 与 `/sitemap-index.xml`

优先级与更新频率：
- 首页：priority 1.0，changefreq daily
- 博客：priority 0.9，changefreq weekly
- 笔记：priority 0.9，changefreq weekly
- 页面：priority 0.6，changefreq monthly

## 涉及代码

- `src/pages/sitemap.xml.ts`
  - 从内容集合生成主网站地图，过滤草稿与 `-index.md`：
  ```ts
  const [blogPosts, pages, notes] = await Promise.all([
    getCollection('blog', ({data, filePath}) => !data.draft && !filePath?.endsWith('-index.md')),
    getCollection('pages', ({data, filePath}) => !data.draft && !filePath?.endsWith('-index.md')),
    getCollection('notes', ({data, filePath}) => !data.draft && !filePath?.endsWith('-index.md'))
  ]);

  // 生成 URL 条目（示例）
  urls.push(`
  <url>
    <loc>${siteUrl}/blog/${post.id}</loc>
    <lastmod>${lastmod.toISOString().split('T')[0]}</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.9</priority>
  </url>`);
  ```

- `src/pages/sitemap-index.xml.ts`
  - 生成索引文件，指向主 `sitemap.xml`：
  ```ts
  const sitemapIndex = `<?xml version="1.0" encoding="UTF-8"?>
  <sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
    <sitemap>
      <loc>${siteUrl}/sitemap.xml</loc>
      <lastmod>${new Date().toISOString()}</lastmod>
    </sitemap>
  </sitemapindex>`;
  ```

- `src/lib/config.ts`
  - 站点域名配置与选择逻辑：
  ```ts
  export const getSiteUrl = () => (
    import.meta.env.PUBLIC_ENV === 'production' ? SITE_INFO.URL : SITE_INFO.DEV_URL
  );
  ```

- `public/robots.txt`
  - 已包含 `Sitemap: https://ttdd.top/sitemap-index.xml`，如需更换域名请同步修改。

## 使用方法

- 本地开发
  - `npm run dev`
  - 访问 `http://localhost:4321/sitemap.xml` 与 `http://localhost:4321/sitemap-index.xml`

- 生产部署
  - 构建部署后自动生成
  - 在 `src/lib/config.ts` 填写你的生产域名（`SITE_INFO.URL`），并确保运行环境设置正确（`PUBLIC_ENV=production` 时将使用生产域名）
  - 在 `public/robots.txt` 替换为你的实际域名

- 搜索引擎提交
  - Google Search Console：提交 `sitemap-index.xml`
  - Bing / 百度等：在各自站长平台提交 `sitemap-index.xml` 地址

完成以上配置后，网站地图将随内容更新而动态生成，有助于提升搜索引擎收录与站点 SEO 表现。